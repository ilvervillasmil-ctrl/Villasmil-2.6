#!/bin/bash
# VILLASMIL-Î© v2.6 - DEPLOY (draft PRs)
# Author: Ilver Villasmil â€“ The Arquitecto
# Usage: edit REPO_OWNER/REMOTE_URL/AUTHOR_EMAIL then: chmod +x deploy_villasmil_omega.sh && ./deploy_villasmil_omega.sh

set -e

# ===== CONFIGURE =====
REPO_OWNER="YOUR_GITHUB_USERNAME"    # <-- update (e.g. ilvervillasmil-ctrl)
REPO_NAME="Villasmil-2.6"            # <-- update if repository name differs
REMOTE_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}.git"
AUTHOR_NAME="Ilver Villasmil"
AUTHOR_EMAIL="ilver@villasmil.com"   # <-- update
PR_LABELS="draft,automation"         # comma-separated labels to apply to PRs (requires gh api permission)

# ===== colors =====
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'; NC='\033[0m'

info(){ echo -e "${CYAN}[INFO]${NC} $*"; }
ok(){ echo -e "${GREEN}âœ… $*${NC}"; }
warn(){ echo -e "${YELLOW}âš ï¸  $*${NC}"; }
err(){ echo -e "${RED}âŒ $*${NC}"; }

# ===== prechecks =====
if ! command -v git &>/dev/null; then err "git not installed"; exit 1; fi
if ! command -v gh &>/dev/null; then warn "gh CLI not found â€” script will push branches but cannot auto-create PRs"; GH_AVAILABLE=false; else GH_AVAILABLE=true; fi

# Ensure inside git repo
if ! git rev-parse --git-dir &>/dev/null; then err "Not in a git repository. Run 'git init' or clone first."; exit 1; fi

# Configure git author
git config user.name "$AUTHOR_NAME"
git config user.email "$AUTHOR_EMAIL"
info "Git author set to: $AUTHOR_NAME <$AUTHOR_EMAIL>"

# Ensure remote origin exists and points to REMOTE_URL
if git remote get-url origin &>/dev/null; then
    ORIG_URL=$(git remote get-url origin)
    info "Current origin: $ORIG_URL"
    if [ "$ORIG_URL" != "$REMOTE_URL" ]; then
        warn "origin URL differs from configured REMOTE_URL."
        echo "  origin: $ORIG_URL"
        echo "  expected: $REMOTE_URL"
        read -p "Replace origin with $REMOTE_URL? [y/N]: " choice
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            git remote set-url origin "$REMOTE_URL"
            ok "origin set to $REMOTE_URL"
        else
            warn "Keeping existing origin."
        fi
    fi
else
    info "No origin remote found. Adding origin -> $REMOTE_URL"
    git remote add origin "$REMOTE_URL"
    ok "origin added"
fi

# ===== create branch: feature/test-harness =====
info "Creating branch: feature/test-harness"
git checkout -B feature/test-harness
git add villasmil_omega core || true
git add villasmil_omega/core.py tests/test_a2_2.py tests/test_basic.py requirements.txt || true
git commit -m "Add core prototype and A2.2 test harness

- core.py (Î˜, L2, PPR)
- tests/test_a2_2.py (A2.2 harness)
- tests/test_basic.py (basic suite)
- requirements.txt

Author: $AUTHOR_NAME" || true
git push -u origin feature/test-harness --force
ok "Pushed feature/test-harness"

# ===== create branch: feature/docs-full =====
info "Creating branch: feature/docs-full"
git checkout main || true
git checkout -B feature/docs-full
git add docs/ protocol/ README.md LICENSE || true
git commit -m "Add architecture docs, schemas and README

- docs/02-architecture.md
- protocol/messages.proto
- README.md, LICENSE

Author: $AUTHOR_NAME" || true
git push -u origin feature/docs-full --force
ok "Pushed feature/docs-full"

# ===== create draft PRs (if gh available) =====
if [ "$GH_AVAILABLE" = true ]; then
    info "Creating draft PR for feature/test-harness ..."
    gh pr create --base main --head feature/test-harness \
        --title "ðŸ§ª Test Harness & Core Prototype (draft)" \
        --body "Core prototype and A2.2 test harness. Author: $AUTHOR_NAME. Draft PR for review." \
        --draft || warn "Failed to create PR for test-harness"

    # apply labels via gh api if labels provided
    if [ -n "$PR_LABELS" ]; then
        PR_NUM=$(gh pr list --head feature/test-harness --json number -q '.[0].number')
        if [ -n "$PR_NUM" ]; then
            gh api repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUM/labels -f labels="$PR_LABELS" >/dev/null || warn "Could not add labels to test-harness PR"
        fi
    fi
    ok "Draft PR created for feature/test-harness"

    info "Creating draft PR for feature/docs-full ..."
    gh pr create --base main --head feature/docs-full \
        --title "ðŸ“š Complete Architecture Docs & Schemas (draft)" \
        --body "Full architecture documentation and protocol schemas. Author: $AUTHOR_NAME. Draft PR for review." \
        --draft || warn "Failed to create PR for docs-full"

    if [ -n "$PR_LABELS" ]; then
        PR_NUM2=$(gh pr list --head feature/docs-full --json number -q '.[0].number')
        if [ -n "$PR_NUM2" ]; then
            gh api repos/$REPO_OWNER/$REPO_NAME/issues/$PR_NUM2/labels -f labels="$PR_LABELS" >/dev/null || warn "Could not add labels to docs-full PR"
        fi
    fi
    ok "Draft PR created for feature/docs-full"
else
    warn "gh CLI not available â€” branches pushed. Create draft PRs manually in GitHub UI."
    echo "Compare/PR URLs:"
    echo "  https://github.com/$REPO_OWNER/$REPO_NAME/compare/main...feature/test-harness"
    echo "  https://github.com/$REPO_OWNER/$REPO_NAME/compare/main...feature/docs-full"
fi

# ===== wrap up =====
git checkout main || true
ok "Deployment script finished. Review PRs and run tests:"
echo "  python -m tests.test_basic"
echo "  python -m tests.test_a2_2"
