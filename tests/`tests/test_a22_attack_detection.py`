from villasmil_omega.core import computethetapremises


def test_a22_attack_detected_when_global_tension_exceeds_threshold():
    """
    Caso A2.2 del manual:
    4 premisas con alta coherencia local pero incompatibilidad global.
    Debe producir tensión global C = 0.5 > 0.30 (ataque detectado).
    """

    premises = [
        {"id": 1, "constraints": {"A": True,  "B": False}},   # p1
        {"id": 2, "constraints": {"A": True,  "C": True}},    # p2
        {"id": 3, "constraints": {"B": True,  "C": False}},   # p3
        {"id": 4, "constraints": {"A": False, "B": True}},    # p4
    ]

    theta = computethetapremises(premises)

    # Según la especificación, aquí hay 3 pares incompatibles de 6 → C = 3/6 = 0.5
    assert theta == 0.5
    assert theta > 0.30  # umbral de ataque A2.2
