from villasmil_omega.core import computeR


def test_computeR_drops_when_global_tension_increases():
    """
    Contexto sano vs. contexto atacado (A2.2):
    MC y CI se mantienen altos, pero la tensión global θC sube.
    RC debe caer de forma significativa.
    """

    # Contexto sano (inspirado en tu ejemplo RC ≈ 0.855)
    MC = 0.75
    CI = 0.96
    phiC = 0.02       # ruido estructural bajo
    deltasem = 0.03   # buena continuidad semántica
    thetaC_safe = 0.05
    PH = 1.0
    NS = 1

    RC_safe = computeR(MC, CI, phiC, deltasem, thetaC_safe, PH, NS)

    # Contexto atacado: mismo MC y CI aparentes, pero tensión global mucho mayor
    thetaC_attack = 0.60  # ataque A2.2 fuerte (por encima de 0.30)
    RC_attack = computeR(MC, CI, phiC, deltasem, thetaC_attack, PH, NS)

    # Verificamos que:
    # 1) El contexto sano es altamente relevante.
    assert RC_safe > 0.80

    # 2) El ataque A2.2 reduce claramente la relevancia.
    assert RC_attack < RC_safe

    # 3) La caída es significativa, no ruido mínimo.
    assert RC_safe - RC_attack >= 0.10
