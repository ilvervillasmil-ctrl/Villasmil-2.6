import pytest
import villasmil_omega.core as core
import villasmil_omega.l2_model as l2m
import villasmil_omega.human_l2.puntos as pts
from villasmil_omega.respiro import should_apply

def test_coherencia_total_absoluta():
    # --- 1. CORE: Forzar balance y guardias (82, 84, 90-94) ---
    core.compute_theta([]) # Línea 82
    core.compute_theta(["model a"] * 10) # Línea 84
    # Forzar rama de balance (93-94) con descriptores válidos
    cluster = ["model a descriptor"] * 3 + ["model b descriptor"] * 3
    core.compute_theta(cluster)

    # --- 2. PUNTOS: Estados de Riesgo y Recuperación (180-189) ---
    sistema = pts.SistemaCoherenciaMaxima()
    # Inicialización mu_self (180)
    sistema.mu_self = None
    sistema.registrar_medicion({"f": 0.5}, {"c": 0.5})
    # Forzar RIESGO (186)
    sistema.mu_self, sistema.MAD_self = 0.1, 0.001
    sistema.registrar_medicion({"fatiga_fisica": 0.9}, {"c": 0.5})
    # Forzar RECUPERACIÓN (188)
    sistema.mu_self = 0.9
    sistema.registrar_medicion({"fatiga_fisica": 0.1}, {"c": 0.5})

    # --- 3. L2_MODEL: Protecciones y Swaps (42, 52-53, 89, 103-107) ---
    l2m.ajustar_L2(-1.0, 1.0) # Línea 52
    l2m.ajustar_L2(2.0, 1.0) # Línea 53
    # Swap de seguridad min > max (89)
    l2m.compute_L2_final(0.1, 0.1, 0.5, 0.5, [0.1], 0.25, 1.0, 0.9, 0.1)
    # Saturación Bio-max (103-107)
    l2m.compute_L2_final(0.0, 0.0, 0.0, 0.0, [0.25], 0.25, 1.0, 0.0, 1.0)

    # --- 4. RESPIRO E INVARIANCIA (40-41, 12) ---
    should_apply(0.5, {"e": 1.5}, {"e": 1.6}, cost_threshold=1.0)
    from villasmil_omega.cierre.invariancia import Invariancia
    Invariancia(epsilon=0.001).es_invariante([0.5, 0.5, 0.502])
