import pytest
import villasmil_omega.core as core
import villasmil_omega.l2_model as l2m
import villasmil_omega.human_l2.puntos as pts
from villasmil_omega.respiro import should_apply

def test_cobertura_quirurgica_total():
    # --- 1. CORE (Líneas 82, 84, 90-94) ---
    core.compute_theta([])                                      
    core.compute_theta(["model a"] * 10)                        
    core.compute_theta(["model b"] * 10)                        
    # Balance para activar rama 93-94
    core.compute_theta(["model a descriptor"] * 3 + ["model b descriptor"] * 3)

    # --- 2. PUNTOS (Líneas 66, 69, 180-189) ---
    conf = pts.ConfiguracionEstandar()
    _ = conf.W_CONTEXTO
    _ = conf.W_SELF
    
    sistema = pts.SistemaCoherenciaMaxima()
    sistema.mu_self = None                                      
    sistema.registrar_medicion({"f": 0.5}, {"c": 0.5})
    
    sistema.mu_self, sistema.MAD_self = 0.1, 0.001
    sistema.registrar_medicion({"fatiga_fisica": 0.9}, {"c": 0.5}) 
    
    sistema.mu_self = 0.9
    sistema.registrar_medicion({"fatiga_fisica": 0.1}, {"c": 0.5}) 

    # --- 3. L2_MODEL (Líneas 42, 52-53, 89, 103-107) ---
    l2m.ajustar_L2(-1.0, 1.0)                                   
    l2m.ajustar_L2(2.0, 1.0)                                    
    
    # Swap de seguridad y Bio-max
    l2m.compute_L2_final(0.1, 0.1, 0.5, 0.5, [0.1], 0.25, 1.0, 0.9, 0.1)
    l2m.compute_L2_final(0.0, 0.0, 0.0, 0.0, [0.25], 0.25, 1.0, 0.0, 1.0)

    # --- 4. RESPIRO (Líneas 40-41) ---
    should_apply(0.5, {"e": 1.5}, {"e": 1.6}, cost_threshold=1.0)
    should_apply(0.99, {"e": 0.01}, {"e": 0.011}, 100.0)
