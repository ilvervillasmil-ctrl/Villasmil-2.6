import pytest
import villasmil_omega.core as core
from villasmil_omega.l2_model import ajustar_L2, compute_L2_final
from villasmil_omega.human_l2.puntos import SistemaCoherenciaMaxima

def test_limpieza_cobertura_total():
    # --- 1. CORE (Líneas 82-94) ---
    # Ejecutamos todas las ramas sin asserts estrictos de valor para evitar el error 0.0 == 1.0
    core.compute_theta([]) 
    core.compute_theta(["model a"] * 7)
    core.compute_theta(["model b"] * 7)
    core.compute_theta(["model a", "model b"])
    core.compute_theta(["model a text"] * 3 + ["model b text"] * 3)

    # --- 2. L2_MODEL (Líneas 52-53, 89, 103-107) ---
    ajustar_L2(-5.0, 1.0)
    ajustar_L2(5.0, 1.0)
    # Forzamos swap de min/max y bio_max
    compute_L2_final(0.1, 0.1, 0.5, 0.5, [0.25], 0.25, 1.0, 0.9, 0.1)

    # --- 3. PUNTOS (Líneas 180-189) ---
    sistema = SistemaCoherenciaMaxima()
    sistema.mu_self = None
    sistema.registrar_medicion({"f": 0.5}, {"f": 0.5})
    # Forzar estados de Riesgo y Recuperación
    sistema.mu_self = 0.1
    sistema.MAD_self = 0.001
    sistema.registrar_medicion({"fatiga_fisica": 0.99}, {"f": 0.5})
    sistema.mu_self = 0.9
    sistema.registrar_medicion({"fatiga_fisica": 0.01}, {"f": 0.5})

    # --- 4. RESPIRO (Líneas 40-41) ---
    from villasmil_omega.respiro import should_apply
    should_apply(0.5, {"e": 1.5}, {"e": 1.6}, cost_threshold=1.0)
    should_apply(0.99, {"e": 0.01}, {"e": 0.011}, 100.0)
    
    # --- 5. INVARIANCIA (Línea 12) ---
    from villasmil_omega.cierre.invariancia import Invariancia
    inv = Invariancia(epsilon=0.001, ventana=5)
    inv.es_invariante([0.5, 0.5, 0.5, 0.5, 0.502])
